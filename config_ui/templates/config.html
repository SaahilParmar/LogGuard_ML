{% extends "base.html" %}

{% block title %}Configuration - LogGuard ML{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-cog"></i> Configuration</h1>
    <div>
        <button class="btn btn-success" onclick="saveConfig()">
            <i class="fas fa-save"></i> Save Configuration
        </button>
        <button class="btn btn-secondary ms-2" onclick="validateConfig()">
            <i class="fas fa-check"></i> Validate
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-file-code"></i> Configuration Editor</h5>
            </div>
            <div class="card-body">
                <textarea id="config-editor" class="form-control" rows="20" style="font-family: monospace;">{{ config | tojson(indent=2) if config else '{}' }}</textarea>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Edit the JSON configuration above. Changes will be validated before saving.
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-exclamation-triangle"></i> Validation Results</h5>
            </div>
            <div class="card-body">
                <div id="validation-results">
                    <p class="text-muted">Click "Validate" to check configuration...</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Configuration Backups</h5>
            </div>
            <div class="card-body">
                <div id="backup-list">
                    <p class="text-muted">Backups are created automatically when saving</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-question-circle"></i> Configuration Help</h5>
            </div>
            <div class="card-body">
                <small>
                    <strong>Required sections:</strong><br>
                    • <code>log_patterns</code> - Log parsing patterns<br>
                    • <code>ml_model</code> - ML model settings<br><br>
                    
                    <strong>ML Model Options:</strong><br>
                    • <code>algorithm</code>: isolation_forest, one_class_svm, local_outlier_factor, ensemble<br>
                    • <code>contamination</code>: 0.01 to 0.5<br>
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function validateConfig() {
    const configText = document.getElementById('config-editor').value;
    let config;
    
    try {
        config = JSON.parse(configText);
    } catch (e) {
        document.getElementById('validation-results').innerHTML = 
            '<div class="alert alert-danger"><i class="fas fa-times"></i> Invalid JSON format</div>';
        return;
    }
    
    fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('validation-results').innerHTML = 
                '<div class="alert alert-success"><i class="fas fa-check"></i> Configuration is valid!</div>';
        } else {
            const errors = data.errors || [data.error];
            const errorList = errors.map(err => `<li>${err}</li>`).join('');
            document.getElementById('validation-results').innerHTML = 
                `<div class="alert alert-danger"><i class="fas fa-times"></i> Validation errors:<ul>${errorList}</ul></div>`;
        }
    })
    .catch(error => {
        document.getElementById('validation-results').innerHTML = 
            '<div class="alert alert-danger"><i class="fas fa-times"></i> Error validating configuration</div>';
    });
}

function saveConfig() {
    validateConfig();
    // In a real implementation, you would save after successful validation
    setTimeout(() => {
        const resultsDiv = document.getElementById('validation-results');
        if (resultsDiv.innerHTML.includes('alert-success')) {
            resultsDiv.innerHTML += '<div class="alert alert-info mt-2"><i class="fas fa-save"></i> Configuration saved successfully!</div>';
        }
    }, 500);
}

// Load current configuration
fetch('/api/config')
    .then(response => response.json())
    .then(config => {
        document.getElementById('config-editor').value = JSON.stringify(config, null, 2);
    });
</script>
{% endblock %}
