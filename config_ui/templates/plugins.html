{% extends "base.html" %}

{% block title %}Plugins - LogGuard ML{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-puzzle-piece"></i> Plugin Management</h1>
    <div>
        <button class="btn btn-primary" onclick="refreshPlugins()">
            <i class="fas fa-sync"></i> Refresh Plugins
        </button>
        <button class="btn btn-success ms-2" onclick="loadPlugins()">
            <i class="fas fa-download"></i> Load Plugins
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Available Plugins</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for category, plugin_list in plugins.items() %}
                    <div class="col-md-4 mb-4">
                        <div class="card border-secondary">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-folder"></i> {{ category.replace('_', ' ').title() }}
                                    <span class="badge bg-light text-dark ms-2">{{ plugin_list|length }}</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if plugin_list %}
                                    {% for plugin in plugin_list %}
                                    <div class="plugin-item mb-3 p-2 border rounded">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">
                                                    {% if plugin.name is defined %}
                                                        {{ plugin.name }}
                                                    {% else %}
                                                        {{ plugin }}
                                                    {% endif %}
                                                </h6>
                                                {% if plugin.description is defined %}
                                                <small class="text-muted">{{ plugin.description }}</small>
                                                {% elif plugin.error is defined %}
                                                <small class="text-danger">{{ plugin.error }}</small>
                                                {% else %}
                                                <small class="text-muted">Plugin loaded successfully</small>
                                                {% endif %}
                                            </div>
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> Active
                                            </span>
                                        </div>
                                        {% if plugin.version is defined %}
                                        <div class="mt-2">
                                            <small class="text-muted">Version: {{ plugin.version }}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                <p class="text-muted">No plugins in this category</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Plugin Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <h3>{{ plugins.values() | list | map('length') | sum }}</h3>
                        <small class="text-muted">Total Plugins</small>
                    </div>
                    <div class="col-md-4">
                        <h3>{{ plugins.keys() | list | length }}</h3>
                        <small class="text-muted">Categories</small>
                    </div>
                    <div class="col-md-4">
                        <h3>{{ plugins.values() | list | map('length') | sum }}</h3>
                        <small class="text-muted">Active</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus"></i> Add New Plugin</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Plugin File</label>
                    <input type="file" class="form-control" id="plugin-file" accept=".py">
                </div>
                <div class="mb-3">
                    <label class="form-label">Plugin Category</label>
                    <select class="form-select" id="plugin-category">
                        <option value="ml_detectors">ML Detectors</option>
                        <option value="output_formats">Output Formats</option>
                        <option value="log_parsers">Log Parsers</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="uploadPlugin()">
                    <i class="fas fa-upload"></i> Upload Plugin
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Plugin Development Guide</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-brain"></i> ML Detectors</h6>
                        <small class="text-muted">
                            Implement custom anomaly detection algorithms. 
                            Must inherit from <code>BaseDetector</code> and implement 
                            <code>fit()</code> and <code>predict()</code> methods.
                        </small>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-file-export"></i> Output Formats</h6>
                        <small class="text-muted">
                            Create custom report formats. Must inherit from 
                            <code>BaseFormatter</code> and implement 
                            <code>format_data()</code> method.
                        </small>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-search"></i> Log Parsers</h6>
                        <small class="text-muted">
                            Develop specialized log parsing logic. Must inherit from 
                            <code>BaseParser</code> and implement 
                            <code>parse_line()</code> method.
                        </small>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Note:</strong> All plugins must include proper metadata in their docstrings 
                        including name, version, description, and author information.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshPlugins() {
    fetch('/api/plugins')
        .then(response => response.json())
        .then(data => {
            console.log('Plugins refreshed:', data);
            // Reload the page to show updated plugin list
            window.location.reload();
        })
        .catch(error => {
            console.error('Error refreshing plugins:', error);
            alert('Error refreshing plugins');
        });
}

function loadPlugins() {
    // Simulate plugin loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        alert('Plugins loaded successfully!');
        refreshPlugins();
    }, 2000);
}

function uploadPlugin() {
    const fileInput = document.getElementById('plugin-file');
    const categorySelect = document.getElementById('plugin-category');
    
    if (!fileInput.files[0]) {
        alert('Please select a plugin file');
        return;
    }
    
    // Simulate plugin upload
    alert(`Plugin upload would be implemented here for category: ${categorySelect.value}`);
}

// Auto-refresh plugin stats every 30 seconds
setInterval(() => {
    fetch('/api/plugins')
        .then(response => response.json())
        .then(data => {
            // Update plugin counts without reloading page
            console.log('Plugin stats updated:', data.total_count);
        })
        .catch(error => {
            console.error('Error updating plugin stats:', error);
        });
}, 30000);
</script>
{% endblock %}
